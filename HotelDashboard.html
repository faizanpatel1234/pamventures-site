<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Night Report Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #f8fafc;
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
        }
        
        /* Navigation Animation */
        .nav-link {
            position: relative;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -4px;
            left: 0;
            background-color: #3b82f6;
            transition: width 0.3s ease-in-out;
        }
        .nav-link:hover::after {
            width: 100%;
        }

        /* Card Hover Effects */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
            border: 1px solid rgba(229, 231, 235, 0.5);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Fade In Animation */
        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom Scrollbar for Table */
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        /* Glassmorphism Navbar */
        .glass-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(229, 231, 235, 0.5);
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Navigation Bar -->
    <nav class="glass-nav fixed w-full z-50 top-0 transition-all duration-300">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <i class="fas fa-hotel text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight">Night Report</h1>
                    <p class="text-xs text-slate-500 font-medium" id="lastUpdatedNav">Syncing...</p>
                </div>
            </div>
            
            <div class="hidden md:flex space-x-8 text-sm font-medium text-slate-600">
                <a href="#overview" class="nav-link hover:text-blue-600 transition-colors">Overview</a>
                <a href="#analytics" class="nav-link hover:text-blue-600 transition-colors">Analytics</a>
                <a href="#daily-sheet" class="nav-link hover:text-blue-600 transition-colors">Daily Sheet</a>
            </div>

            <button onclick="fetchData()" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto px-6 pt-24 pb-12">
        
        <!-- Loading State -->
        <div id="loading" class="flex flex-col items-center justify-center min-h-[60vh]">
            <div class="loader mb-4"></div>
            <p class="text-slate-500 font-medium">Fetching live data from Excel...</p>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard" class="hidden">
            
            <!-- SECTION 1: OVERVIEW (KPIs) -->
            <section id="overview" class="mb-12 scroll-mt-28">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Overview</h2>
                        <p class="text-slate-500 text-sm mt-1">Key Performance Indicators (Month to Date)</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Room Revenue -->
                    <div class="card p-6 border-t-4 border-blue-500 fade-in" style="animation-delay: 0.1s;">
                        <div class="flex justify-between items-start mb-4">
                            <div class="bg-blue-50 p-3 rounded-lg text-blue-600">
                                <i class="fas fa-bed fa-lg"></i>
                            </div>
                            <span class="text-xs font-semibold text-green-600 bg-green-50 px-2 py-1 rounded-full">Revenue</span>
                        </div>
                        <h3 class="text-slate-500 text-sm font-medium">Room Revenue</h3>
                        <p class="text-2xl font-bold text-slate-800 mt-1" id="kpi-room">₹0</p>
                    </div>

                    <!-- F&B Net -->
                    <div class="card p-6 border-t-4 border-emerald-500 fade-in" style="animation-delay: 0.2s;">
                        <div class="flex justify-between items-start mb-4">
                            <div class="bg-emerald-50 p-3 rounded-lg text-emerald-600">
                                <i class="fas fa-utensils fa-lg"></i>
                            </div>
                            <span class="text-xs font-semibold text-green-600 bg-green-50 px-2 py-1 rounded-full">Net</span>
                        </div>
                        <h3 class="text-slate-500 text-sm font-medium">F&B Net</h3>
                        <p class="text-2xl font-bold text-slate-800 mt-1" id="kpi-fnb">₹0</p>
                    </div>

                    <!-- Total Collections -->
                    <div class="card p-6 border-t-4 border-violet-500 fade-in" style="animation-delay: 0.3s;">
                        <div class="flex justify-between items-start mb-4">
                            <div class="bg-violet-50 p-3 rounded-lg text-violet-600">
                                <i class="fas fa-cash-register fa-lg"></i>
                            </div>
                            <span class="text-xs font-semibold text-violet-600 bg-violet-50 px-2 py-1 rounded-full">Cash Flow</span>
                        </div>
                        <h3 class="text-slate-500 text-sm font-medium">Total Collections</h3>
                        <p class="text-2xl font-bold text-slate-800 mt-1" id="kpi-collection">₹0</p>
                    </div>

                    <!-- Advance Collections -->
                    <div class="card p-6 border-t-4 border-orange-500 fade-in" style="animation-delay: 0.4s;">
                        <div class="flex justify-between items-start mb-4">
                            <div class="bg-orange-50 p-3 rounded-lg text-orange-600">
                                <i class="fas fa-clock fa-lg"></i>
                            </div>
                            <span class="text-xs font-semibold text-orange-600 bg-orange-50 px-2 py-1 rounded-full">Future</span>
                        </div>
                        <h3 class="text-slate-500 text-sm font-medium">Advance Collections</h3>
                        <p class="text-2xl font-bold text-slate-800 mt-1" id="kpi-advance">₹0</p>
                    </div>
                </div>

                <!-- Secondary KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                    <div class="card p-4 flex items-center gap-4 fade-in" style="animation-delay: 0.5s;">
                        <div class="p-2 bg-gray-100 rounded-full text-gray-600"><i class="fas fa-file-invoice-dollar"></i></div>
                        <div>
                            <p class="text-xs text-slate-500 uppercase font-semibold">Total Taxes</p>
                            <p class="text-lg font-bold text-slate-700" id="kpi-taxes">₹0</p>
                        </div>
                    </div>
                    <div class="card p-4 flex items-center gap-4 fade-in" style="animation-delay: 0.6s;">
                        <div class="p-2 bg-red-50 rounded-full text-red-500"><i class="fas fa-receipt"></i></div>
                        <div>
                            <p class="text-xs text-slate-500 uppercase font-semibold">F&B Allowance</p>
                            <p class="text-lg font-bold text-slate-700" id="kpi-allowance">₹0</p>
                        </div>
                    </div>
                    <div class="card p-4 flex items-center gap-4 fade-in" style="animation-delay: 0.7s;">
                        <div class="p-2 bg-teal-50 rounded-full text-teal-600"><i class="fas fa-wallet"></i></div>
                        <div>
                            <p class="text-xs text-slate-500 uppercase font-semibold">Carry Forward FOM</p>
                            <p class="text-lg font-bold text-slate-700" id="kpi-carry">₹0</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION 2: ANALYTICS (Charts) -->
            <section id="analytics" class="mb-12 scroll-mt-28">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">Analytics</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Main Trend Chart -->
                    <div class="card p-6 lg:col-span-2">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-slate-700">Revenue Trends</h3>
                            <select id="chartFilter" class="bg-slate-50 border border-slate-200 text-slate-600 text-xs rounded-lg px-3 py-2 outline-none">
                                <option value="all">Last 30 Days</option>
                                <option value="7">Last 7 Days</option>
                            </select>
                        </div>
                        <div class="h-80 w-full relative">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>

                    <!-- Revenue Mix -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold text-slate-700 mb-6">Revenue Mix</h3>
                        <div class="h-64 w-full relative flex justify-center">
                            <canvas id="mixChart"></canvas>
                        </div>
                        <div class="mt-6 space-y-3">
                            <div class="flex justify-between text-sm">
                                <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-500"></span> Room</span>
                                <span class="font-semibold text-slate-700" id="legend-room">0%</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-emerald-500"></span> F&B</span>
                                <span class="font-semibold text-slate-700" id="legend-fb">0%</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-orange-500"></span> Taxes</span>
                                <span class="font-semibold text-slate-700" id="legend-tax">0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION 3: DAILY SHEET (Table) -->
            <section id="daily-sheet" class="scroll-mt-28">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Daily Sheet</h2>
                    <div class="flex gap-2">
                         <span class="text-xs bg-slate-100 text-slate-600 px-3 py-1 rounded-full flex items-center">
                            <i class="fas fa-database mr-2"></i> Live Data
                         </span>
                    </div>
                </div>

                <div class="card overflow-hidden">
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-600 uppercase text-xs font-semibold border-b border-slate-200">
                                <tr>
                                    <th class="px-6 py-4 whitespace-nowrap sticky left-0 bg-slate-50 z-10">Date</th>
                                    <th class="px-6 py-4 whitespace-nowrap text-right">Room Tariff</th>
                                    <th class="px-6 py-4 whitespace-nowrap text-right">F&B Gross</th>
                                    <th class="px-6 py-4 whitespace-nowrap text-right">F&B Allow</th>
                                    <th class="px-6 py-4 whitespace-nowrap text-right text-emerald-600">F&B Net</th>
                                    <th class="px-6 py-4 whitespace-nowrap text-right">Other Sales</th>
                                    <th class="px-6 py-4 whitespace-nowrap text-right">Taxes</th>
                                    <th class="px-6 py-4 whitespace-nowrap text-right">Advance Col.</th>
                                    <th class="px-6 py-4 whitespace-nowrap text-right text-violet-600">Total Col.</th>
                                    <th class="px-6 py-4 whitespace-nowrap text-right">Excess/Short</th>
                                    <th class="px-6 py-4 whitespace-nowrap text-right">FOM Carry Fwd</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody" class="divide-y divide-slate-100">
                                <!-- JS will populate this -->
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 bg-slate-50 border-t border-slate-100 text-center text-xs text-slate-500">
                        End of Report
                    </div>
                </div>
            </section>

            <!-- Footer -->
            <footer class="mt-12 border-t border-slate-200 py-8 text-center text-slate-400 text-sm">
                <p>&copy; 2026 Hotel Management System. Data sourced from Live Excel.</p>
            </footer>

        </div>

        <!-- Error State -->
        <div id="errorMessage" class="hidden max-w-lg mx-auto mt-20 p-6 bg-red-50 rounded-xl border border-red-100 text-center">
            <div class="text-red-500 text-4xl mb-4"><i class="fas fa-exclamation-circle"></i></div>
            <h3 class="text-lg font-bold text-red-800 mb-2">Connection Error</h3>
            <p class="text-red-600 text-sm mb-4" id="errorText">Unable to fetch data.</p>
            <button onclick="location.reload()" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-700">Try Again</button>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQhYL-hk8dYhYUZO3DZ502SGhXgYyXOpQwmOmrxghMfI7BcV4Nm4qAsD1byPxF3mZ2onw5HhwPV_JR8/pub?output=csv';

        // --- UTILS ---
        const formatCurrency = (num) => {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 0
            }).format(num);
        };

        const parseCSV = (str) => {
            const arr = [];
            let quote = false; 
            for (let row = 0, col = 0, c = 0; c < str.length; c++) {
                let cc = str[c], nc = str[c+1];
                arr[row] = arr[row] || [];
                arr[row][col] = arr[row][col] || '';
                if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; }
                else if (cc == '"') { quote = !quote; }
                else if (cc == ',' && !quote) { ++col; }
                else if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; }
                else if ((cc == '\n' || cc == '\r') && !quote) { ++row; col = 0; }
                else { arr[row][col] += cc; }
            }
            return arr;
        }

        // --- MAIN LOGIC ---
        let charts = {}; // Store chart instances to destroy/update later

        async function fetchData() {
            // Show loading
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');

            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error("Network response was not ok");
                
                const csvText = await response.text();
                const rawData = parseCSV(csvText);

                // --- DATA MAPPING ---
                // Based on File: Daily_Night_Report.csv
                // Headers: Date, Room Tariff, F&B Gross, F&B Allowance, F&B Net, Other Sales Net, Taxes, Advance Collection, Total Collection, Excess / Short, Carry Forward FOM
                
                const headers = rawData[0].map(h => h.trim().toLowerCase());
                const dataRows = rawData.slice(1).filter(r => r.length > 1 && r[0]); 

                const getIdx = (name) => headers.findIndex(h => h.includes(name));
                
                // Mappings
                const idxDate = getIdx('date');
                const idxRoom = getIdx('room tariff');
                const idxFbGross = getIdx('f&b gross');
                const idxFbAllow = getIdx('f&b allowance');
                const idxFbNet = getIdx('f&b net');
                const idxOther = getIdx('other sales');
                const idxTaxes = getIdx('taxes');
                const idxAdvance = getIdx('advance collection');
                const idxCollection = getIdx('total collection');
                const idxExcess = getIdx('excess');
                const idxCarry = getIdx('carry forward');

                const processedData = dataRows.map(row => ({
                    date: row[idxDate],
                    room: parseFloat(row[idxRoom] || 0),
                    fbGross: parseFloat(row[idxFbGross] || 0),
                    fbAllow: parseFloat(row[idxFbAllow] || 0),
                    fbNet: parseFloat(row[idxFbNet] || 0),
                    other: parseFloat(row[idxOther] || 0),
                    taxes: parseFloat(row[idxTaxes] || 0),
                    advance: parseFloat(row[idxAdvance] || 0),
                    collection: parseFloat(row[idxCollection] || 0),
                    excess: parseFloat(row[idxExcess] || 0),
                    carry: parseFloat(row[idxCarry] || 0)
                }));

                updateUI(processedData);

            } catch (error) {
                console.error("Error:", error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('errorText').textContent = error.message;
            }
        }

        function updateUI(data) {
            // 1. Calculate Totals for KPIs
            const totals = data.reduce((acc, curr) => ({
                room: acc.room + curr.room,
                fbNet: acc.fbNet + curr.fbNet,
                collection: acc.collection + curr.collection,
                taxes: acc.taxes + curr.taxes,
                advance: acc.advance + curr.advance,
                allowance: acc.allowance + curr.fbAllow,
                // For carry forward, we usually want the *latest* value, not sum, but depending on data logic.
                // Assuming "Carry Forward FOM" is a running balance, we take the last entry's value.
                carry: curr.carry // Will end up being the last row's value
            }), { room:0, fbNet:0, collection:0, taxes:0, advance:0, allowance:0, carry:0 });

            // 2. Update KPI DOM
            document.getElementById('kpi-room').textContent = formatCurrency(totals.room);
            document.getElementById('kpi-fnb').textContent = formatCurrency(totals.fbNet);
            document.getElementById('kpi-collection').textContent = formatCurrency(totals.collection);
            document.getElementById('kpi-taxes').textContent = formatCurrency(totals.taxes);
            document.getElementById('kpi-advance').textContent = formatCurrency(totals.advance);
            document.getElementById('kpi-allowance').textContent = formatCurrency(totals.allowance);
            
            // For Carry Forward, get the value from the most recent date entry (first in list if reversed, or last in raw)
            // Processed Data is in original order (oldest to newest usually).
            const lastEntry = data[data.length - 1];
            document.getElementById('kpi-carry').textContent = formatCurrency(lastEntry ? lastEntry.carry : 0);

            // Update Time
            const now = new Date();
            document.getElementById('lastUpdatedNav').textContent = "Updated: " + now.toLocaleTimeString();

            // 3. Render Charts
            renderCharts(data, totals);

            // 4. Render Table (Reverse order for newest first)
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            [...data].reverse().forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "bg-white hover:bg-slate-50 transition-colors border-b border-slate-100 group";
                
                // Helper for cells
                const td = (val, extraClasses = "") => `<td class="px-6 py-4 font-medium whitespace-nowrap ${extraClasses}">${val}</td>`;
                const tdNum = (val, extraClasses = "text-slate-600") => `<td class="px-6 py-4 text-right whitespace-nowrap ${extraClasses}">${formatCurrency(val)}</td>`;

                tr.innerHTML = `
                    ${td(row.date, "text-slate-800 sticky left-0 bg-white group-hover:bg-slate-50 border-r border-transparent group-hover:border-slate-200")}
                    ${tdNum(row.room)}
                    ${tdNum(row.fbGross)}
                    ${tdNum(row.fbAllow, "text-red-400")}
                    ${tdNum(row.fbNet, "text-emerald-600 font-semibold")}
                    ${tdNum(row.other)}
                    ${tdNum(row.taxes)}
                    ${tdNum(row.advance, "text-orange-500")}
                    ${tdNum(row.collection, "text-violet-600 font-bold bg-violet-50/50")}
                    ${tdNum(row.excess, row.excess < 0 ? "text-red-500" : "text-slate-500")}
                    ${tdNum(row.carry, "text-slate-500")}
                `;
                tbody.appendChild(tr);
            });

            // Show Dashboard
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function renderCharts(data, totals) {
            const labels = data.map(d => d.date);
            
            // Destroy existing if refresh
            if(charts.revenue) charts.revenue.destroy();
            if(charts.mix) charts.mix.destroy();

            // 1. Revenue Chart
            const ctxRev = document.getElementById('revenueChart').getContext('2d');
            charts.revenue = new Chart(ctxRev, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Room',
                            data: data.map(d => d.room),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.05)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 2,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'F&B Net',
                            data: data.map(d => d.fbNet),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.05)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 2,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', align: 'end', labels: { boxWidth: 10, usePointStyle: true } },
                        tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(255,255,255,0.9)', titleColor:'#1e293b', bodyColor:'#475569', borderColor:'#e2e8f0', borderWidth:1 }
                    },
                    scales: {
                        y: { grid: { borderDash: [2, 4], color: '#f1f5f9' }, beginAtZero: true },
                        x: { grid: { display: false } }
                    }
                }
            });

            // 2. Mix Chart (Doughnut)
            const ctxMix = document.getElementById('mixChart').getContext('2d');
            const totalNet = totals.room + totals.fbNet + totals.taxes;
            
            // Update Legend Texts
            document.getElementById('legend-room').innerText = Math.round((totals.room/totalNet)*100) + "%";
            document.getElementById('legend-fb').innerText = Math.round((totals.fbNet/totalNet)*100) + "%";
            document.getElementById('legend-tax').innerText = Math.round((totals.taxes/totalNet)*100) + "%";

            charts.mix = new Chart(ctxMix, {
                type: 'doughnut',
                data: {
                    labels: ['Room', 'F&B', 'Taxes', 'Other'],
                    datasets: [{
                        data: [totals.room, totals.fbNet, totals.taxes, totals.other],
                        backgroundColor: ['#3b82f6', '#10b981', '#f97316', '#cbd5e1'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Init
        fetchData();

    </script>
</body>
</html>
