<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Night Report Dashboard</title>
    
    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #f3f4f6;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- Navigation / Header -->
    <nav class="bg-slate-900 text-white p-6 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold"><i class="fas fa-hotel mr-3"></i>Night Report Dashboard</h1>
            <div class="text-sm opacity-80" id="lastUpdated">Last Updated: Loading...</div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto p-6">
        
        <!-- Loading Indicator -->
        <div id="loading" class="text-center py-20">
            <div class="loader"></div>
            <p class="text-gray-600 mt-4">Connecting to your live Excel sheet...</p>
        </div>

        <!-- Dashboard Content (Hidden until loaded) -->
        <div id="dashboard" class="hidden">
            
            <!-- KPI Cards Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- KPI 1 -->
                <div class="card p-6 border-l-4 border-blue-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm font-semibold uppercase">Total Room Revenue</p>
                            <h2 class="text-2xl font-bold text-gray-800 mt-2" id="kpi-room">₹0</h2>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full text-blue-500">
                            <i class="fas fa-bed fa-lg"></i>
                        </div>
                    </div>
                </div>

                <!-- KPI 2 -->
                <div class="card p-6 border-l-4 border-green-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm font-semibold uppercase">Total F&B Net</p>
                            <h2 class="text-2xl font-bold text-gray-800 mt-2" id="kpi-fnb">₹0</h2>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full text-green-500">
                            <i class="fas fa-utensils fa-lg"></i>
                        </div>
                    </div>
                </div>

                <!-- KPI 3 -->
                <div class="card p-6 border-l-4 border-purple-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm font-semibold uppercase">Total Collections</p>
                            <h2 class="text-2xl font-bold text-gray-800 mt-2" id="kpi-collection">₹0</h2>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full text-purple-500">
                            <i class="fas fa-cash-register fa-lg"></i>
                        </div>
                    </div>
                </div>

                <!-- KPI 4 -->
                <div class="card p-6 border-l-4 border-orange-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm font-semibold uppercase">Total Taxes</p>
                            <h2 class="text-2xl font-bold text-gray-800 mt-2" id="kpi-taxes">₹0</h2>
                        </div>
                        <div class="bg-orange-100 p-3 rounded-full text-orange-500">
                            <i class="fas fa-file-invoice-dollar fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Line Chart (Main) -->
                <div class="card p-6 lg:col-span-2">
                    <h3 class="text-lg font-bold text-gray-700 mb-4">Daily Revenue Trend (Room vs F&B)</h3>
                    <div class="h-80 relative w-full">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <!-- Doughnut Chart -->
                <div class="card p-6">
                    <h3 class="text-lg font-bold text-gray-700 mb-4">Revenue Mix</h3>
                    <div class="h-64 relative w-full flex justify-center">
                        <canvas id="mixChart"></canvas>
                    </div>
                    <div class="mt-4 text-center text-sm text-gray-500">
                        Breakdown of Total Net Revenue
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="card p-6 mb-8">
                <h3 class="text-lg font-bold text-gray-700 mb-4">Total Collection vs Taxes</h3>
                <div class="h-64 relative w-full">
                    <canvas id="collectionChart"></canvas>
                </div>
            </div>

            <!-- Data Table (Collapsible) -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4 cursor-pointer" onclick="toggleTable()">
                    <h3 class="text-lg font-bold text-gray-700">Recent Data Entries</h3>
                    <i class="fas fa-chevron-down text-gray-400"></i>
                </div>
                <div id="tableContainer" class="hidden overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-6 py-3">Date</th>
                                <th class="px-6 py-3">Room Tariff</th>
                                <th class="px-6 py-3">F&B Net</th>
                                <th class="px-6 py-3">Collection</th>
                                <th class="px-6 py-3">Taxes</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- Rows inserted by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

        <!-- Error Message Container -->
        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-4" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline" id="errorText">Something went wrong fetching the data.</span>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        // This is the link you provided. 
        // IMPORTANT: Ensure this link points to the 'Daily_Night_Report' sheet specifically if your Excel has multiple tabs.
        // If the dashboard looks weird, Publish ONLY the 'Daily_Night_Report' tab to CSV in Google Sheets.
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQhYL-hk8dYhYUZO3DZ502SGhXgYyXOpQwmOmrxghMfI7BcV4Nm4qAsD1byPxF3mZ2onw5HhwPV_JR8/pub?output=csv';

        // --- UTILS ---
        const formatCurrency = (num) => {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 0
            }).format(num);
        };

        const parseCSV = (str) => {
            const arr = [];
            let quote = false;  // 'true' means we're inside a quoted field

            // Iterate over each character, keep track of current row and column (of the returned array)
            for (let row = 0, col = 0, c = 0; c < str.length; c++) {
                let cc = str[c], nc = str[c+1];        // Current character, next character
                arr[row] = arr[row] || [];             // Create a new row if necessary
                arr[row][col] = arr[row][col] || '';   // Create a new column (start with empty string) if necessary

                // If the current character is a quotation mark, and we're inside a
                // quoted field, and the next character is also a quotation mark,
                // add a quotation mark to the current column and skip the next character
                if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; }

                // If it's just one quotation mark, begin/end quoted field
                else if (cc == '"') { quote = !quote; }

                // If it's a comma and we're not in a quoted field, move on to the next column
                else if (cc == ',' && !quote) { ++col; }

                // If it's a newline (CRLF) and we're not in a quoted field, skip the next character
                // and move on to the next row and move to column 0 of that new row
                else if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; }

                // If it's a newline (LF or CR) and we're not in a quoted field,
                // move on to the next row and move to column 0 of that new row
                else if ((cc == '\n' || cc == '\r') && !quote) { ++row; col = 0; }

                // Otherwise, push the current character to the current column
                else { arr[row][col] += cc; }
            }
            return arr;
        }

        // --- MAIN LOGIC ---
        async function fetchData() {
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error("Network response was not ok");
                
                const csvText = await response.text();
                const rawData = parseCSV(csvText);

                // Assuming the first row is headers
                // Expected Headers based on your file:
                // Date, Room Tariff, F&B Gross, F&B Allowance, F&B Net, Other Sales Net, Taxes, Advance Collection, Total Collection...
                
                const headers = rawData[0].map(h => h.trim().toLowerCase());
                const dataRows = rawData.slice(1).filter(r => r.length > 1 && r[0]); // Remove empty rows

                // Map column indices (Dynamic approach in case columns move slightly)
                const getIdx = (name) => headers.findIndex(h => h.includes(name));
                
                const idxDate = getIdx('date');
                const idxRoom = getIdx('room tariff');
                const idxFbNet = getIdx('f&b net');
                const idxCollection = getIdx('total collection');
                const idxTaxes = getIdx('taxes');
                const idxOther = getIdx('other sales');

                // Process Data
                const processedData = dataRows.map(row => {
                    return {
                        date: row[idxDate],
                        room: parseFloat(row[idxRoom] || 0),
                        fb: parseFloat(row[idxFbNet] || 0),
                        collection: parseFloat(row[idxCollection] || 0),
                        taxes: parseFloat(row[idxTaxes] || 0),
                        other: parseFloat(row[idxOther] || 0)
                    };
                });

                updateDashboard(processedData);

            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('errorText').textContent = "Could not load data. Ensure the Google Sheet link is correct and published as CSV. Details: " + error.message;
            }
        }

        function updateDashboard(data) {
            // 1. Calculate Totals
            const totalRoom = data.reduce((sum, item) => sum + item.room, 0);
            const totalFb = data.reduce((sum, item) => sum + item.fb, 0);
            const totalCollection = data.reduce((sum, item) => sum + item.collection, 0);
            const totalTaxes = data.reduce((sum, item) => sum + item.taxes, 0);
            const totalOther = data.reduce((sum, item) => sum + item.other, 0);

            // 2. Update UI Cards
            document.getElementById('kpi-room').textContent = formatCurrency(totalRoom);
            document.getElementById('kpi-fnb').textContent = formatCurrency(totalFb);
            document.getElementById('kpi-collection').textContent = formatCurrency(totalCollection);
            document.getElementById('kpi-taxes').textContent = formatCurrency(totalTaxes);
            
            const today = new Date();
            document.getElementById('lastUpdated').textContent = "Last Updated: " + today.toLocaleDateString() + " " + today.toLocaleTimeString();

            // 3. Prepare Chart Data
            const labels = data.map(d => d.date);
            
            // Chart 1: Revenue Line Chart
            new Chart(document.getElementById('revenueChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Room Revenue',
                            data: data.map(d => d.room),
                            borderColor: '#3b82f6', // Blue
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'F&B Revenue',
                            data: data.map(d => d.fb),
                            borderColor: '#10b981', // Green
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Chart 2: Revenue Mix (Pie)
            new Chart(document.getElementById('mixChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Room', 'F&B', 'Other', 'Taxes'],
                    datasets: [{
                        data: [totalRoom, totalFb, totalOther, totalTaxes],
                        backgroundColor: ['#3b82f6', '#10b981', '#6b7280', '#f97316']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // Chart 3: Collections Bar Chart
            new Chart(document.getElementById('collectionChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Collection',
                            data: data.map(d => d.collection),
                            backgroundColor: '#8b5cf6' // Purple
                        },
                        {
                            label: 'Taxes Collected',
                            data: data.map(d => d.taxes),
                            backgroundColor: '#f97316' // Orange
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });

            // 4. Populate Table
            const tbody = document.getElementById('dataTableBody');
            // Show last 7 entries
            const recentData = data.slice(-7).reverse(); 
            recentData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${row.date}</td>
                    <td class="px-6 py-4 text-blue-600">${formatCurrency(row.room)}</td>
                    <td class="px-6 py-4 text-green-600">${formatCurrency(row.fb)}</td>
                    <td class="px-6 py-4 text-purple-600 font-bold">${formatCurrency(row.collection)}</td>
                    <td class="px-6 py-4 text-gray-500">${formatCurrency(row.taxes)}</td>
                `;
                tbody.appendChild(tr);
            });

            // Finish Loading
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function toggleTable() {
            const container = document.getElementById('tableContainer');
            container.classList.toggle('hidden');
        }

        // Start
        fetchData();

    </script>
</body>
</html>
