<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Finance Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS (XLSX) for Excel parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Custom Font (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "recharts": "https://esm.sh/recharts@2.12.7?external=react,react-dom",
            "lucide-react": "https://esm.sh/lucide-react@0.395.0?external=react,react-dom"
        }
    }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        .sidebar-link.active {
            background-color: #eff6ff;
            color: #2563eb;
            border-right: 3px solid #2563eb;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slideIn { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="text-slate-800">
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer 
        } from 'recharts';
        import { 
            LayoutDashboard, Upload, TrendingUp, TrendingDown, 
            FileText, Plus, Trash2, Save, Download, Menu, X,
            Calendar, Filter, Settings, RefreshCw, AlertCircle
        } from 'lucide-react';

        // --- Utility Functions ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatCurrency = (val) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(val);
        const formatDate = (d) => d ? new Date(d).toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' }) : '';

        // --- Components ---

        const StatCard = ({ title, value, type }) => {
            const isIncome = type === 'income';
            return (
                <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center justify-between">
                    <div>
                        <p className="text-slate-500 text-sm font-medium mb-1">{title}</p>
                        <h3 className={`text-2xl font-bold ${isIncome ? 'text-emerald-600' : 'text-slate-800'}`}>{value}</h3>
                    </div>
                    <div className={`p-3 rounded-xl ${isIncome ? 'bg-emerald-50 text-emerald-600' : 'bg-slate-100 text-slate-600'}`}>
                        {isIncome ? <TrendingUp size={24} /> : <TrendingDown size={24} />}
                    </div>
                </div>
            );
        };

        const Importer = ({ onImport, onClear }) => {
            const [file, setFile] = useState(null);
            const [reportDate, setReportDate] = useState(new Date().toISOString().split('T')[0]);
            const [preview, setPreview] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);

            const handleFile = async (e) => {
                const f = e.target.files[0];
                if (!f) return;
                setFile(f);
                setPreview([]);
            };

            const processFile = async () => {
                if (!file) return;
                setIsProcessing(true);

                const data = await file.arrayBuffer();
                const workbook = window.XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = window.XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: "" });

                // --- SMART PARSER FOR IDS NEXT NIGHT REPORT ---
                const transactions = [];
                let descCol = 0; // Usually column A
                let amountCol = -1; // We need to find this
                
                // 1. Locate Headers
                // We look for a row containing "Description" and "NET" or "Amount"
                let headerRowIdx = -1;
                
                for(let i=0; i<Math.min(rows.length, 25); i++) {
                    const rowStr = rows[i].map(c => String(c).toLowerCase());
                    if (rowStr.includes('description')) {
                        headerRowIdx = i;
                        // Find the first "NET" column or "Amount" column in this row
                        // The user's file typically has: Description | Amount | Allowance | NET | ...
                        // We usually want the FIRST NET column (For The Day)
                        const netIndices = rowStr.map((val, idx) => val === 'net' ? idx : -1).filter(idx => idx !== -1);
                        if (netIndices.length > 0) amountCol = netIndices[0];
                        else {
                             // Fallback to "Amount" if NET is missing
                             const amtIndices = rowStr.map((val, idx) => val === 'amount' ? idx : -1).filter(idx => idx !== -1);
                             if (amtIndices.length > 0) amountCol = amtIndices[0];
                        }
                        break;
                    }
                }

                if (headerRowIdx === -1 || amountCol === -1) {
                    alert("Could not auto-detect specific report format. Please ensure 'Description' and 'NET' columns exist.");
                    setIsProcessing(false);
                    return;
                }

                // 2. Iterate and Filter
                for (let i = headerRowIdx + 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row) continue;

                    const rawDesc = row[descCol];
                    const rawAmt = row[amountCol];

                    // Strict Filtering Rules
                    if (!rawDesc || typeof rawDesc !== 'string') continue;
                    const desc = rawDesc.trim();
                    const descLower = desc.toLowerCase();
                    
                    // -- SKIP RULES --
                    if (desc === '') continue;
                    if (desc.startsWith('_') || desc.startsWith('-')) continue; // Dividers
                    if (desc.includes(':-')) continue; // Section headers like "Rate :-"
                    if (descLower.includes('total')) continue; // EXCLUDE TOTALS (Double counting fix)
                    if (descLower.includes('guest name')) continue; 
                    if (descLower.includes('list of')) continue; 
                    if (descLower.includes('description')) continue; // Header repeat

                    const amount = parseFloat(rawAmt);
                    if (isNaN(amount) || amount === 0) continue;

                    // Categorization Logic
                    let category = 'Other Revenue';
                    if (descLower.includes('room') || descLower.includes('tariff') || descLower.includes('retention') || descLower.includes('bed')) category = 'Room Revenue';
                    else if (descLower.includes('food') || descLower.includes('bev') || descLower.includes('restaurant') || descLower.includes('bqt') || descLower.includes('banquet') || descLower.includes('breakfast') || descLower.includes('lunch') || descLower.includes('dinner')) category = 'F&B';
                    else if (descLower.includes('laundry')) category = 'Laundry';
                    else if (descLower.includes('telephone') || descLower.includes('internet') || descLower.includes('wifi') || descLower.includes('misc')) category = 'Misc/Utilities';

                    transactions.push({
                        id: generateId(),
                        date: new Date(reportDate).toISOString(),
                        description: desc,
                        amount: Math.abs(amount),
                        type: 'income', // Night reports are predominantly income
                        category: category,
                        source: 'Night Report'
                    });
                }

                setPreview(transactions);
                setIsProcessing(false);
            };

            const confirm = () => {
                if(preview.length === 0) return;
                onImport(preview);
                setFile(null);
                setPreview([]);
                alert("Import Successful!");
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-8 rounded-2xl border border-dashed border-slate-300 text-center">
                        {!file ? (
                            <>
                                <div className="mx-auto w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mb-4">
                                    <FileText size={32} />
                                </div>
                                <h3 className="text-lg font-semibold text-slate-800">Upload Night Report</h3>
                                <p className="text-slate-500 mb-6 text-sm">Supports IDS Next .xlsx or .csv exports</p>
                                <input type="file" accept=".xlsx,.csv,.xls" className="hidden" id="fileIn" onChange={handleFile} />
                                <label htmlFor="fileIn" className="inline-block px-6 py-2 bg-slate-900 text-white rounded-lg cursor-pointer hover:bg-slate-800 transition-colors font-medium">
                                    Select File
                                </label>
                            </>
                        ) : (
                            <div className="text-left max-w-lg mx-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 bg-green-100 text-green-700 rounded-lg flex items-center justify-center font-bold text-xs">XLS</div>
                                        <div>
                                            <p className="font-medium text-slate-800 text-sm">{file.name}</p>
                                            <button onClick={() => { setFile(null); setPreview([]); }} className="text-xs text-red-500 hover:underline">Remove</button>
                                        </div>
                                    </div>
                                    <input 
                                        type="date" 
                                        value={reportDate} 
                                        onChange={e => setReportDate(e.target.value)}
                                        className="border border-slate-200 rounded-lg px-3 py-1.5 text-sm"
                                    />
                                </div>

                                {preview.length === 0 ? (
                                    <button 
                                        onClick={processFile} 
                                        disabled={isProcessing}
                                        className="w-full py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-medium transition-colors flex items-center justify-center gap-2"
                                    >
                                        {isProcessing ? <RefreshCw className="animate-spin" size={20} /> : <Filter size={20} />}
                                        Process Night Report (Filter Noise)
                                    </button>
                                ) : (
                                    <div className="space-y-4">
                                        <div className="bg-blue-50 text-blue-700 p-4 rounded-xl flex items-start gap-3 text-sm">
                                            <AlertCircle className="shrink-0 mt-0.5" size={16} />
                                            <div>
                                                <p className="font-bold">Ready to Import {preview.length} Items</p>
                                                <p className="opacity-90 mt-1">We automatically removed "Totals", dividers, and headers to prevent double counting.</p>
                                            </div>
                                        </div>
                                        <div className="max-h-60 overflow-y-auto border border-slate-200 rounded-xl">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-slate-50 text-xs uppercase text-slate-500 sticky top-0">
                                                    <tr>
                                                        <th className="p-3">Description</th>
                                                        <th className="p-3">Category</th>
                                                        <th className="p-3 text-right">Amount</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100 bg-white">
                                                    {preview.map((row, i) => (
                                                        <tr key={i}>
                                                            <td className="p-3 font-medium text-slate-700">{row.description}</td>
                                                            <td className="p-3 text-slate-500 text-xs">{row.category}</td>
                                                            <td className="p-3 text-right font-bold text-emerald-600">{formatCurrency(row.amount)}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                        <button 
                                            onClick={confirm}
                                            className="w-full py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 font-bold transition-colors shadow-lg shadow-emerald-200"
                                        >
                                            Confirm Import
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    
                    <div className="border-t border-slate-200 pt-6">
                         <h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Settings size={18} /> Data Management</h4>
                         <button 
                            onClick={onClear}
                            className="text-red-600 border border-red-200 bg-red-50 hover:bg-red-100 px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                         >
                            Clear All Dashboard Data
                         </button>
                    </div>
                </div>
            );
        };

        const MainApp = () => {
            const [view, setView] = useState('dashboard');
            const [data, setData] = useState([]);
            const [sidebarOpen, setSidebarOpen] = useState(false);

            useEffect(() => {
                const saved = localStorage.getItem('hotel_dash_v2');
                if (saved) {
                    try { setData(JSON.parse(saved)); } catch(e) {}
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('hotel_dash_v2', JSON.stringify(data));
            }, [data]);

            const stats = useMemo(() => {
                const income = data.filter(d => d.type === 'income').reduce((a, b) => a + b.amount, 0);
                const expense = data.filter(d => d.type === 'expense').reduce((a, b) => a + b.amount, 0);
                
                // Group by Category
                const catGroup = data.filter(d => d.type === 'income').reduce((acc, curr) => {
                    acc[curr.category] = (acc[curr.category] || 0) + curr.amount;
                    return acc;
                }, {});
                const catData = Object.keys(catGroup).map(k => ({ name: k, value: catGroup[k] }));

                // Last 7 days trend
                const last7 = [...Array(7)].map((_, i) => {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    return d.toISOString().split('T')[0];
                }).reverse();
                
                const trend = last7.map(date => ({
                    date: new Date(date).toLocaleDateString('en-US', {weekday: 'short'}),
                    income: data.filter(d => d.date.startsWith(date) && d.type === 'income').reduce((a, b) => a + b.amount, 0)
                }));

                return { income, expense, catData, trend };
            }, [data]);

            const handleDelete = (id) => {
                if(confirm("Delete this entry?")) setData(prev => prev.filter(item => item.id !== id));
            };

            const handleClearAll = () => {
                if(confirm("WARNING: This will delete ALL data. Are you sure?")) {
                    setData([]);
                    alert("All data cleared.");
                }
            };

            return (
                <div className="min-h-screen flex font-sans bg-slate-50">
                    {/* Mobile Menu Button */}
                    <button onClick={() => setSidebarOpen(!sidebarOpen)} className="lg:hidden fixed bottom-6 right-6 bg-slate-900 text-white p-4 rounded-full shadow-xl z-50">
                        {sidebarOpen ? <X /> : <Menu />}
                    </button>

                    {/* Sidebar */}
                    <aside className={`fixed lg:static inset-y-0 left-0 w-72 bg-white border-r border-slate-200 transform transition-transform duration-300 z-40 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'}`}>
                        <div className="p-8">
                            <h1 className="text-2xl font-black text-slate-900 tracking-tight">Hotel<span className="text-blue-600">Dash</span></h1>
                        </div>
                        <nav className="px-4 space-y-2">
                            <button onClick={() => setView('dashboard')} className={`sidebar-link w-full text-left px-6 py-3 rounded-xl font-medium transition-colors ${view === 'dashboard' ? 'active' : 'text-slate-500 hover:bg-slate-50'}`}>
                                Dashboard
                            </button>
                            <button onClick={() => setView('transactions')} className={`sidebar-link w-full text-left px-6 py-3 rounded-xl font-medium transition-colors ${view === 'transactions' ? 'active' : 'text-slate-500 hover:bg-slate-50'}`}>
                                All Transactions
                            </button>
                            <button onClick={() => setView('import')} className={`sidebar-link w-full text-left px-6 py-3 rounded-xl font-medium transition-colors ${view === 'import' ? 'active' : 'text-slate-500 hover:bg-slate-50'}`}>
                                Import Data
                            </button>
                        </nav>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 p-6 lg:p-12 overflow-y-auto h-screen">
                        <div className="max-w-6xl mx-auto animate-slideIn">
                            <header className="mb-10 flex justify-between items-end">
                                <div>
                                    <h2 className="text-3xl font-bold text-slate-900 capitalize">{view === 'dashboard' ? 'Overview' : view}</h2>
                                    <p className="text-slate-500 mt-2">Manage your hotel finances efficiently.</p>
                                </div>
                                {view === 'dashboard' && (
                                    <div className="hidden md:block text-right">
                                        <p className="text-xs font-bold uppercase text-slate-400 tracking-wider">Net Profit</p>
                                        <p className="text-2xl font-bold text-slate-900">{formatCurrency(stats.income - stats.expense)}</p>
                                    </div>
                                )}
                            </header>

                            {view === 'dashboard' && (
                                <div className="space-y-8">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <StatCard title="Total Revenue" value={formatCurrency(stats.income)} type="income" />
                                        <StatCard title="Total Expenses" value={formatCurrency(stats.expense)} type="expense" />
                                    </div>
                                    
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm col-span-2">
                                            <h3 className="font-bold text-slate-800 mb-6">Revenue Trend (7 Days)</h3>
                                            <div className="h-64">
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <BarChart data={stats.trend}>
                                                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                        <XAxis dataKey="date" axisLine={false} tickLine={false} tick={{fill:'#94a3b8'}} />
                                                        <Tooltip contentStyle={{borderRadius:'12px', border:'none', boxShadow:'0 10px 15px -3px rgba(0,0,0,0.1)'}} />
                                                        <Bar dataKey="income" fill="#2563eb" radius={[6, 6, 0, 0]} barSize={40} />
                                                    </BarChart>
                                                </ResponsiveContainer>
                                            </div>
                                        </div>
                                        <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                                            <h3 className="font-bold text-slate-800 mb-6">Source Breakdown</h3>
                                            <div className="h-64">
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <PieChart>
                                                        <Pie data={stats.catData} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">
                                                            {stats.catData.map((entry, index) => (
                                                                <Cell key={`cell-${index}`} fill={['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'][index % 4]} />
                                                            ))}
                                                        </Pie>
                                                        <Tooltip formatter={(val) => formatCurrency(val)} />
                                                        <Legend verticalAlign="bottom" height={36}/>
                                                    </PieChart>
                                                </ResponsiveContainer>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {view === 'transactions' && (
                                <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left text-sm">
                                            <thead className="bg-slate-50 text-slate-500 uppercase text-xs font-semibold">
                                                <tr>
                                                    <th className="p-4">Date</th>
                                                    <th className="p-4">Description</th>
                                                    <th className="p-4">Category</th>
                                                    <th className="p-4 text-right">Amount</th>
                                                    <th className="p-4 text-center">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {data.sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => (
                                                    <tr key={t.id} className="hover:bg-slate-50">
                                                        <td className="p-4 text-slate-500 whitespace-nowrap">{formatDate(t.date)}</td>
                                                        <td className="p-4 font-medium text-slate-800">{t.description}</td>
                                                        <td className="p-4"><span className="px-2 py-1 bg-slate-100 rounded text-xs text-slate-600">{t.category}</span></td>
                                                        <td className={`p-4 text-right font-bold ${t.type === 'income' ? 'text-emerald-600' : 'text-red-600'}`}>
                                                            {t.type === 'income' ? '+' : '-'}{formatCurrency(t.amount)}
                                                        </td>
                                                        <td className="p-4 text-center">
                                                            <button onClick={() => handleDelete(t.id)} className="text-slate-300 hover:text-red-500"><Trash2 size={18} /></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {data.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-slate-400">No data found. Import some files!</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {view === 'import' && (
                                <Importer 
                                    onImport={(newData) => { setData(prev => [...prev, ...newData]); setView('dashboard'); }} 
                                    onClear={handleClearAll}
                                />
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>
